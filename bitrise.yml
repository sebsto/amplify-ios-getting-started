---
format_version: '20'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: ios
app:
  envs:
  - TEST_SHARD_COUNT: 2
  - BITRISE_PROJECT_PATH: code/getting started.xcodeproj
    opts:
      is_expand: false
  - BITRISE_SCHEME: getting started
    opts:
      is_expand: false
  - BITRISE_DISTRIBUTION_METHOD: app-store
    opts:
      is_expand: false

workflows:
  build_test_depoy:
    summary: Run your Xcode tests and get the test report.
    description: The workflow will first clone your Git repository, cache and
      install your project's dependencies if any, run your Xcode tests and save
      the test results.
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            envman add --key BITRISE_WORKING_DIR --value $(mktemp -d)
    
    - change-workdir:
        inputs:
        - path: "$BITRISE_WORKING_DIR"
        
    - git-clone@8: {}

    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x
            # Prepare the keychain
            code/ci_actions/01_keychain.sh
            # Prepare Amplify
            code/ci_actions/02_amplify.sh
        title: Pre-Build
    
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x
            # Build
            code/ci_actions/03_build.sh
        title: Build

    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x
            # Tests
            code/ci_actions/04_local_tests.sh
            code/ci_actions/05_devicefarm_tests.sh
        title: Tests

    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x
            # Deploy
            code/ci_actions/06_deploy_testflight.sh
        title: Deploy

    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x
            # Cleanup
            code/ci_actions/07_cleanup.sh
        title: Cleanup
      
meta:
  bitrise.io:
    stack: agent-pool-71860415-46e6-4223-96a2-a98cd4ce7afc
